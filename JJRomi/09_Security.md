# CHAPTER 9. Security

## 인증과 권한부여
시스템과 상호작용하는 인간과 사물에 있어 핵심적인 개념이다.
권한부여는 권한주체를 허용된 행위와 매핑하는 메커니즘이다.
단일 모놀리식 애플리케이션의 경우 일반적으로 애플리케이션 스스로 인증과 권한부여를 처리한다. 하지만 분산 시스템에서는 한 번의 인증으로 모든 시스템을 이용할 수 있는 단일 신원을 보유해야한다
일반적인 SSO구현체 사용 
권한주체가 웹 기반의 인터페이스를 통해 리소스에 접근하려 할 때 그 사람은 인증을 위해 신원제공에 재전송된다. 신원 제공자는 권한주체의 인증이 충족되면 그 사람의 자원 접근 허용 여부를 결정하도록 서비스 제공자에 정보를 전달한다. 
기업 영역에 사용되는 대표적인 구현체인 SAML과 OpenID Connect는 이 분야를 위한 기능을 제공한다.
SAML은 SOAP 기반의 표준이며 지원 가능한 라이브러리와 도구가 있음에도 불구하고 작업이 꽤 복잡하다.
OpenID Connect는 OAuth 2.0의 특정 구현에서 출발한 표준이며 구글 및 다른 업체에서 SSO를 처리하는 데 사용한다. 
싱글 사이온 게이트웨이 사용
세분화된 권한 부여는 마이크로서비스에 한정해야한다.

## 서비스 대 서비스 인증과 권한부여
경계 안의 모든 것 허용하기
데이터 민감도에 따라 사용해야 한다. 공격자가 네트워크에 침입한다면 전형적인 중간자 공격에 대해 무방비한 상태일 것이다. 
HTTP(S) 기본 인증
HTTP 기본 인증은 클라이언트가 사용자 이름과 패스워드를 표준 HTTP헤더에 넣어서 전송하는 것이다. 그러면 서버는 상세 내용을 확인하고 클라이언트의 서비스 접근 허용 여부를 숭인한다. 네트워크상의 어떠한 중간자도 헤더 정보와 데이터를 볼 수 있으므로 HTTP 기본 인증은 대개 HTTPS 상에서 수행되어야 한다.
장점
클라이언트와 서버 간의 트래픽을 도청하거나 페이로드 조작을 막는 추가적인 보호를 받을 수 있다.
단점
서버 SSL 인증서와 관련하여 추가적인 관리 및 운영 부담이 될 수 있다. 
SSL을 통해 전송된 트래픽은 바니쉬나 스퀴드 같은 리버스 프록시에 의해 캐시될 수 없다.
SAML 또는 OpenID Connect 사용하기
기존의 인프라스트럭처를 사용할 수 있고 모든 서비스의 접근 통제를 중앙의 디렉터리 서버에 모아서 처리할 수 있다. 그리고 중가자 공격을 피하고자 한다면 여전히 HTTPS 상에서 라우팅해야 한다.
클라이언트 인증서
클라이언트의 신원 확인을 위한 또 다른 방법은 클라이언트 인증서 형태의 전송 계층 보안 (TLS)기능을 이요하는 것이다. 클라이언트와 서버의 연결을 체결할 때 사용되는 X.509 인증서가 각 클라이언트에 설치되어 있으며, 서버는 클라이언트 인증서의 진위를 검증하여 유효한 클라이언트인지 확실히 보장할 수 있다.
HTTP 기반의 HMAC
OAuth 명세서 일부와 AWS의 S3 API에 의해 폭넓게 사용되는 해시 가반 코드 (HMAC)를 HTTP 요청의 서명에 사용하는 것이다.
HMAC에서 요청 메세지 바디는 비밀 키를 사용해서 해시되고, 해시 결과는 요청과 함께 전송된다. 그다음에 서버는 자신이 가진 비밀 키의 복제본을 사용해서 해시를 재생성한다. 이들이 서로 일치한다면 서버는 그 요청을 수락한다. 
장점
트래픽이 더 쉽게 캐시되고, 경우에 따라 다르겠지만 아마도 해시를 생성하는 부하가 HTTPS 트래픽을 처리하는 것보다 더 낮다.
단점
클라이언트와 서버 모두 어떤 방식이로든 통신해서 기밀을 공유해야한다. 기밀이 누설된다면 접근을 차단하는 데 문제가 있다.
하나의 패턴이지 표준이 아니므로 다양한 구현 방법이 있다. 그 결과 이 방법에 대한 공개적이며 가용한 양질의 구현체가 부족하다.
제삼자가 요청 내용을 조작하지 않았다는 것과 비밀 키 자체의 기밀성만 보장한다. 요청한 데이터는 네트워크상에서 스누킹하는 사람들에게 여전히 노출된다.
API 키
트위터, 구글, 플리커, AWS 같은 서비스의 모든 공개 API는 API키를 사용한다. API 키를 통해 서비스는 API 호출자를 인식할 수 있고 호출자의 능력에 제한을 둘 수 있다. 이러한 제한은 단순히 자원에 대한 접근 통제를 넘어 다른 조치로 확장될 수 있다.
마이크로서비스 대 마이크로서비스 방식을 다루기 위해 API 키를 사용하는 정확한 동작 메이커즘은 사용하는 기술에 좌우된다. 
대리인 문제
서비스 대 서비스 통신에서 악의적인 당사자가 대리인 서비스를 속여 하위 서비스에 대한 인가되지 않은 호출을 하는 취약점의 한 형태인 혼동된 대리인 문제가 발생할 수 있다.
해결방법은 단순하지 않지만, 해당 연산의 민감도에 따라 호출자의 신원을 검증하거나 호출자에게 원본 권한주체의 자격증명을 요구하는 암묵적인 신뢰방법이 있다.

## 보관 중인 데이터 보호하기
잘 알려진 것을 사용하라
어떤 프로그래밍 언어를 사용하더라도 인정된 암호화 알고리즘의 구현체 중에서 검토를 거쳐 정기적으로 패치되는 것을 구해서 사용해야 한다.
키가 전부다
암호화는 암호화될 데이터와 키를 입력받아 암호화된 데이터를 출력하는 알고리즘에 좌우된다.
데이터를 암호화하지만 그 키를 같은 데이터베이스에 저장하면 안된다.
데이터를 암호화하고 복호화할 보안 장치를 분리한다.
서비스들이 키를 필요로 할 때 접근할 수 있는 분리된 키 금고를 사용하는 것이다. 키에 대한 수명주기 관리는 중요한 자겁이고 이들 시스템은 우리를 대신해서 처리해줄 수 있다.
SQL Server가 제공하는 투명한 데이터 암호화 (TDE)처럼 암호화를 투명하게 처리해주는 기능을 기본 내장한 데이터베이스들도 있다.
암호화 대상 정하기
모든 데이터를 암호화하는 연산 부하는 결과적으로 더 강력한 하드웨어를 필요로 하며 부담이 될 수 있다.
요구형 복호화
데이터의 요청이 있을 때 복호화하고 복호화된 데이터는 어디에도 저장되지 않도록 한다.
백업 암호화하기
특정 버전의 데이터를 처리하기 위해 어떤 키가 필요한지 인지해야한다. 명확한 키관리가 중요하다.

## 심층 방어
방화벽
하나 이상의 방화벽을 구축하는 것은 취할 수 있는 매우 현명한 예방 조치다. 
특정 포트에 대한 특정 종류의 트래픽 접근 제한
특정 IP대역에서 유입되는 접속 차단을 조절하여 악의적 공격 탐지
다중으로 구축하는 방법도 좋다. 
한 호스트의 보안을 위해 허용 가능한 진입 및 진출 트래픽 설정을 하면서 IPTable을 사용하기로 결정
일반적인 접근 통제를 위한 네트워크 경계에 있는 방화벽과 함께 호스트내에서 실행된느 서비스를 대상으로 설정 가능
로깅
좋은 로깅 (특히 다수의 시스템에서 로그를 수집할 수 있는 능력)은 예방을 위한 것이 아니라 나쁜 일의 탐지와 회복에 도움이 된다.
민감한 정보는 로그를 통해 중요한 데이터가 누출되지 않도록 선별되어야 한다.
침입 탐지와 방지 시스템
침입 탐지 시스템 (IDS) 는 문제가 발견될 때 리포팅하며 수상한 행위에 대해 네트워크와 호스트를 모니터링 할 수 있다.
침입 방지 시스템 (IPS) 은 수상한 활동을 모니터링할 뿐만 아니라 나아가 그것이 발생되지 않도록 한다.
문제 경보 면에서 더 수동적인 IDS를 사용하면 그 규칙들을 더 적극적으로 적용하기 전에 잘 조율할 기회를 얻게 된다.
네트워크 분리 (망분리)
마이크로서비스에서는 서비스들의 상호 통신 방법의 통제를 세분화하도록 서비스들을 다른 네트워크 세그먼트에 배치할 수 있다.
운영 체제
소프트웨어를 정기적으로 패치하라. 
만약 버퍼 오버플로 취약점이 패치되지 않은 구 버전의 웹 서버가 root권한으로 머신에서 실행되고 있다면 그 시스템은 극도로 취약할 것이다.

## 절약하라
개인을 식별할 수 있는 정보를 가능한 한 많이 제거해서 바로 적용해보는 것은 어떨까? 
저장하지 않는다면 훔쳐갈 것도 없다. 저장하지 않는다면 아무도 달라고 요청할 것도 없다.
독일어 Datensparsakeit(데이터최소화)는 절대적으로 요구되는 만큼의 정보만 저장하는 개념을 함축하고 있다.

## 인적 요소
조직 내의 인적 요소를 다루기 위한 프로세스와 정책도 필요하다. 악의가 있는 사람의 입장에서 생각하는 것은 필요한 보호 조치를 추론할 수 있는 좋은 방법이며, 그중 일부는 이미 현재의 직원만큼 많은 내부 정보를 보유하고 있다.

## 보안 탑재
보안 문제에 대한 모든 사람의 일반적 인식을 높이는 것이 문제를 줄이는 데 도움이 된다.
OWASP Top Ten, 즉 10대 웹 애플리케이션 취약점 리스트와 OWASP의 보안 테스팅 프레임워크에 친숙해지는 것은 좋은 출발점이다.

## 외부 검증
침투 테스팅과 같은 훈련이 외부에서 수행될 때는 정말로 실제 침투 시도를 흉내낼 수 있다.
매 릴리즈 전에 얼마나 많은 검증이 필요한 지 고려해 볼 필요가 있다. 필요성에 대한 결정은 각자의 위험도 프로파일에 달려있다.



